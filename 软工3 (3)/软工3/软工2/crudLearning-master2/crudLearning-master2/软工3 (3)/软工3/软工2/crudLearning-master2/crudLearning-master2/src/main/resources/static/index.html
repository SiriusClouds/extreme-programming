<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户信息</title>
    <link rel="stylesheet" href="element.css">
</head>
<body style="background-color: #0FF;">
<div id="app" style="width: 80%; margin: 0 auto">
    <h2>用户信息表</h2>

    <el-row>
        <el-col :span="6" style="margin-bottom: 10px">
            <el-button type="primary" @click="add">新增</el-button>
        </el-col>
        <el-col :span="12" style="margin-bottom: 10px; display: flex; align-items: center;">
            <el-input v-model="name" style="width: 70%; margin-right: 10px;" @keyup.enter.native="loadTable(1)"></el-input>
            <el-button type="primary" @click="loadTable(1)">查询</el-button>
        </el-col>
        <el-col :span="6" style="margin-bottom: 10px">
            <el-button type="success" @click="exportContacts">导出通讯录</el-button>
            <el-upload
                    action="http://localhost:8080/user/import"
                    accept=".xlsx"
                    :auto-upload="true"
                    :on-success="importSuccess">
                <el-button type="primary">导入通讯录</el-button>
            </el-upload>
        </el-col>
    </el-row>

    <el-table
            :data="page.content"
            stripe
            border
            style="width: 100%">
        <el-table-column prop="name" label="用户名"></el-table-column>
        <el-table-column prop="age" label="年龄" width="100"></el-table-column>
        <el-table-column prop="sex" label="性别" width="100"></el-table-column>
        <el-table-column prop="contacts" label="联系方式">
            <template slot-scope="scope">
                <div v-for="contact in scope.row.contacts" :key="contact.type">
                    {{ contact.type }}: {{ contact.value }}
                </div>
            </template>
        </el-table-column>
        <el-table-column fixed="right" label="操作" width="150">
            <template slot-scope="scope">
                <el-button type="primary" icon="el-icon-star-off" size="small" circle
                           :class="{ 'is-favorite': scope.row.favorite }"
                           @click="toggleFavorite(scope.row)">
                </el-button>
                <el-button type="primary" icon="el-icon-edit" size="small" circle @click="edit(scope.row)"></el-button>
                <el-button type="danger" icon="el-icon-delete" size="small" circle @click="del(scope.row.id)"></el-button>
            </template>
        </el-table-column>
    </el-table>

    <el-row type="flex" justify="center" style="margin-top: 10px">
        <el-pagination layout="prev, pager, next" :page-size="pageSize" :current-page="pageNum"
                       @prev-click="loadTable" @current-change="loadTable" @next-click="loadTable"
                       :total="page.totalElements">
        </el-pagination>
    </el-row>

    <el-dialog title="用户信息" :visible.sync="dialogVisible" width="30%">
        <el-form ref="form" :model="form" label-width="80px">
            <el-form-item label="用户名">
                <el-input v-model="form.name"></el-input>
            </el-form-item>
            <el-form-item label="年龄">
                <el-input v-model="form.age"></el-input>
            </el-form-item>
            <el-form-item label="性别">
                <el-radio v-model="form.sex" label="男">男</el-radio>
                <el-radio v-model="form.sex" label="女">女</el-radio>
            </el-form-item>
            <el-form-item label="联系方式">
                <div v-for="(contact, index) in form.contacts" :key="index" style="margin-bottom: 10px">
                    <el-input v-model="contact.value" style="width: 80%; margin-right: 10px;"></el-input>
                    <el-select v-model="contact.type" placeholder="类型" style="width: 120px;">
                        <el-option label="电话" value="phone"></el-option>
                        <el-option label="邮箱" value="email"></el-option>
                        <el-option label="社交媒体" value="social"></el-option>
                        <el-option label="地址" value="address"></el-option>
                    </el-select>
                    <el-button type="danger" icon="el-icon-delete" circle @click="removeContact(index)"></el-button>
                </div>
                <el-button type="primary" @click="addContact">添加联系方式</el-button>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button @click="dialogVisible = false">取 消</el-button>
            <el-button type="primary" @click="save">确 定</el-button>
        </span>
    </el-dialog>
</div>

<script src="jquery.min.js"></script>
<script src="vue.js"></script>
<script src="element.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            page: {},
            name: '',
            pageNum: 1,
            pageSize: 8,
            dialogVisible: false,
            form: { contacts: [] }
        },
        created() {
            this.loadTable(this.pageNum);
        },
        methods: {
            loadTable(num) {
                this.pageNum = num;
                $.get(`http://localhost:8080/user/page?pageNum=${this.pageNum}&pageSize=${this.pageSize}&name=${this.name}`)
                    .then(res => {
                        this.page = res.data;
                    });
            },
            add() {
                this.dialogVisible = true;
                this.form = { contacts: [] };
            },
            edit(row) {
                this.form = JSON.parse(JSON.stringify(row));
                this.dialogVisible = true;
            },
            save() {
                const method = this.form.id ? 'put' : 'post';
                $.ajax({
                    url: 'http://localhost:8080/user',
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(this.form)
                }).then(() => {
                    this.dialogVisible = false;
                    this.loadTable(1);
                });
            },
            del(id) {
                $.ajax({
                    url: `http://localhost:8080/user/${id}`,
                    type: 'delete'
                }).then(() => {
                    this.loadTable(1);
                });
            },
            toggleFavorite(row) {
                row.favorite = !row.favorite;
                $.ajax({
                    url: `http://localhost:8080/user/${row.id}/favorite`,
                    type: 'post',
                    contentType: 'application/json',
                    data: JSON.stringify({ favorite: row.favorite })
                }).then(() => {
                    this.$message.success(row.favorite ? "已收藏" : "已取消收藏");
                });
            },
            exportContacts() {
                window.location.href = 'http://localhost:8080/user/export';
            },
            importSuccess() {
                this.$message.success("通讯录导入成功");
                this.loadTable(1);
            },
            addContact() {
                this.form.contacts.push({ type: '', value: '' });
            },
            removeContact(index) {
                this.form.contacts.splice(index, 1);
            }
        }
    });
</script>
</body>
</html>
